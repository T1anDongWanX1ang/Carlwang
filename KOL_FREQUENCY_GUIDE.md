# KOL 推文爬取频率说明

## 📊 当前配置

### 默认频率设置
根据 `daily_kol_tweet_crawler/start_service_kol_tweet.sh` 的配置：

```bash
DEFAULT_INTERVAL=60         # 每 60 分钟运行一次
DEFAULT_MAX_PAGES=50        # 最多抓取 50 页（实际限制15页）
DEFAULT_PAGE_SIZE=100       # 期望每页 100 条（实际固定20条）
DEFAULT_HOURS_LIMIT=3       # 只拉取过去 3 小时的推文
```

---

## ⏰ 爬取频率详解

### 定时服务模式
```bash
./start_service_kol_tweet.sh start
```

**运行方式**：
- **每 60 分钟执行一次爬取**
- 持续运行，直到手动停止
- 自动跳过周末/节假日：❌ 不会，全天候运行

**执行时间线**：
```
00:00 → 爬取一次（拉取过去3小时推文）
01:00 → 爬取一次
02:00 → 爬取一次
03:00 → 爬取一次
...
23:00 → 爬取一次
```

**每日执行次数**：24 次/天

---

## 📈 实际爬取数据量

### 基于 API 实际返回（20条/页）

#### 场景1：活跃 List（推文多）
```
每次爬取：
- 时间窗口: 过去 3 小时
- 最多页数: 15 页（硬限制）
- 实际推文: 15 页 × 20 条 = 300 条
- 成本: $0.045/次

每天：
- 执行次数: 24 次
- 总推文: 24 × 300 = 7,200 条
- 成本: 24 × $0.045 = $1.08

每月：
- 总推文: 7,200 × 30 = 216,000 条
- 成本: $1.08 × 30 = $32.4
```

#### 场景2：中等活跃 List
```
每次爬取：
- 过去3小时约 100 条新推文
- 实际拉取: 5 页 × 20 条 = 100 条
- 成本: $0.015/次

每天：
- 执行次数: 24 次
- 总推文: 24 × 100 = 2,400 条
- 成本: 24 × $0.015 = $0.36

每月：
- 总推文: 2,400 × 30 = 72,000 条
- 成本: $0.36 × 30 = $10.8
```

#### 场景3：低活跃 List
```
每次爬取：
- 过去3小时约 20 条新推文
- 实际拉取: 1 页 × 20 条 = 20 条
- 成本: $0.003/次

每天：
- 执行次数: 24 次
- 总推文: 24 × 20 = 480 条
- 成本: 24 × $0.003 = $0.072

每月：
- 总推文: 480 × 30 = 14,400 条
- 成本: $0.072 × 30 = $2.16
```

---

## 🎛️ 频率调整建议

### 根据 List 活跃度调整

#### 高活跃 List（如大V、热门话题）
推荐：**高频率 + 短时间窗口**
```bash
./start_service_kol_tweet.sh start 30 10 100 1
# 每 30 分钟, 最多 10 页, 过去 1 小时
# 原因: 避免遗漏推文，1小时窗口足够
# 每月成本: 约 $43.2
```

#### 中等活跃 List（普通KOL）
推荐：**标准频率 + 中等窗口**（默认配置）
```bash
./start_service_kol_tweet.sh start 60 10 100 3
# 每 60 分钟, 最多 10 页, 过去 3 小时
# 原因: 平衡成本和数据完整性
# 每月成本: 约 $21.6
```

#### 低活跃 List（小众话题）
推荐：**低频率 + 长时间窗口**
```bash
./start_service_kol_tweet.sh start 120 5 100 6
# 每 120 分钟, 最多 5 页, 过去 6 小时
# 原因: 节省成本，长窗口确保不遗漏
# 每月成本: 约 $5.4
```

---

## 🔄 智能时间检测机制

### 自动停止拉取
即使设置了 `max_pages=50`，系统会在以下情况提前停止：

1. **时间超限**：发现推文超过时间窗口（如3小时前）
2. **无更多数据**：API 返回空数据或无 next_token
3. **达到硬限制**：到达15页上限

### 示例场景
```
设置: 每60分钟, 过去3小时, 最多15页

11:00 执行爬取:
  - 拉取 08:00-11:00 的推文
  - 假设只有 80 条新推文
  - 实际拉取: 4 页（80条）就停止 ✅
  - 节省了 11 页的请求

12:00 执行爬取:
  - 拉取 09:00-12:00 的推文
  - 其中 08:00-09:00 的推文（60条）已经在上次拉取过
  - 只会拉取 11:00-12:00 的新推文（20条）
  - 实际拉取: 1 页 ✅
```

---

## 📊 频率对比表

| 频率 | 间隔 | 每日次数 | 每月次数 | 时间窗口 | 每月成本<br>(中等活跃) |
|------|------|---------|---------|---------|------------------|
| **超高频** | 15分钟 | 96次 | 2,880次 | 0.5小时 | $86.4 |
| **高频** | 30分钟 | 48次 | 1,440次 | 1小时 | $43.2 |
| **标准** | 60分钟 | 24次 | 720次 | 3小时 | $21.6 |
| **低频** | 120分钟 | 12次 | 360次 | 6小时 | $10.8 |
| **超低频** | 240分钟 | 6次 | 180次 | 12小时 | $5.4 |

---

## 🎯 当前状态检查

### 查看是否有 KOL 推文服务正在运行
```bash
ps aux | grep "main.py.*schedule" | grep -v "project"
```

**当前结果**：❌ **KOL 推文服务未运行**

只发现了项目推文服务在运行：
```
--mode project-schedule --interval 15 --max-pages 2
```

---

## 🚀 启动建议

### 方案1：保守起步（推荐新手）
```bash
cd /Users/qmk/Documents/QC/twitter/Carlwang/daily_kol_tweet_crawler

# 先测试一次
./start_service_kol_tweet.sh once 5 100 1

# 确认无误后，启动低频服务
./start_service_kol_tweet.sh start 120 5 100 3
```
**预计成本**：$10.8/月

### 方案2：标准配置（平衡）
```bash
# 使用默认配置启动
./start_service_kol_tweet.sh start
```
**预计成本**：$21.6/月

### 方案3：高频配置（数据完整性优先）
```bash
./start_service_kol_tweet.sh start 30 15 100 1
```
**预计成本**：$64.8/月

---

## 📝 监控和调整

### 监控命令
```bash
# 查看服务状态
./start_service_kol_tweet.sh status

# 查看最近日志
./start_service_kol_tweet.sh logs 50

# 查看成本统计
tail -100 service_kol_tweet.log | grep "cost\|成本"
```

### 动态调整频率
```bash
# 如果发现数据重复率高（说明频率太高）
./start_service_kol_tweet.sh restart 120  # 降低到每2小时

# 如果发现数据断层（说明频率太低）
./start_service_kol_tweet.sh restart 30   # 提高到每30分钟
```

---

## ⚠️ 注意事项

1. **时间窗口要大于频率**
   - ❌ 错误: 每60分钟运行，只拉取过去30分钟 → 会遗漏数据
   - ✅ 正确: 每60分钟运行，拉取过去2-3小时 → 有重叠，确保完整

2. **避免过度重叠**
   - ❌ 浪费: 每60分钟运行，拉取过去24小时 → 大量重复数据
   - ✅ 合理: 每60分钟运行，拉取过去3小时 → 适度重叠

3. **监控数据重复率**
   ```sql
   -- 检查1小时内的重复推文
   SELECT created_at, COUNT(*) as cnt
   FROM twitter_tweet
   WHERE created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)
   GROUP BY id_str
   HAVING cnt > 1;
   ```

---

## 📌 总结

### KOL 推文爬取频率
- **默认**：每 60 分钟（每小时1次）
- **时间窗口**：过去 3 小时
- **执行次数**：24 次/天，720 次/月
- **预计成本**：$10.8 - $32.4/月（取决于活跃度）

### 推荐配置
```bash
# 如果是第一次运行
./start_service_kol_tweet.sh start 60 10 100 3
# 每小时运行一次，过去3小时，预计 $21.6/月
```

### 现在的状态
✅ 已配置完成
❌ 服务未启动

**需要手动启动服务才会开始按频率运行！**
