# 分页限制分析与配置指南

## 📊 当前限制情况

### 数据量计算
- **默认最大页数**: 15页（可通过配置调整）
- **每页大小**: 100条（实际由API返回决定）
- **理论最大数据量**: 15页 × 100条/页 = **1,500条推文**

### 配置位置
配置文件：`config/config.json`
```json
{
  "api": {
    "pagination": {
      "page_size": 100,      // 每页大小（建议值，实际由API决定）
      "max_pages": 50        // 最大页数（代码会使用此配置值）
    }
  }
}
```

## ⚠️ 漏数据风险分析

### 场景1：正常情况（安全）
- **假设**: List有50个账号，每个账号3小时内发3条推文
- **数据量**: 50 × 3 = **150条推文**
- **风险**: ✅ **安全**（远低于1,500条限制）

### 场景2：活跃情况（接近上限）
- **假设**: List有100个账号，每个账号3小时内发10条推文
- **数据量**: 100 × 10 = **1,000条推文**
- **风险**: ⚠️ **接近上限**（需要监控）

### 场景3：热门事件（高风险）
- **假设**: List有200个账号，每个账号3小时内发20条推文
- **数据量**: 200 × 20 = **4,000条推文**
- **风险**: ❌ **会漏数据**（超过1,500条限制）

## 🔧 如何配置最大页数

### 方法1：修改配置文件（推荐）

编辑 `config/config.json`：
```json
{
  "api": {
    "pagination": {
      "max_pages": 50,    // 增加到50页 = 最多5,000条推文
      "page_size": 100
    }
  }
}
```

### 方法2：通过命令行参数

```bash
# 启动服务时指定页数（但会被配置文件的max_pages限制）
./start_service.sh start 60 50 100 3
# 参数说明: [间隔] [页数] [每页条数] [小时限制]
```

**注意**: 命令行参数不能超过配置文件中的 `max_pages` 值。

## 📈 如何评估是否需要增加页数

### 1. 查看日志警告

当达到页数限制时，日志会显示：
```
⚠️ 达到最大页数限制（15页），可能还有更多数据未拉取！
   已获取: 1,350 条推文
   理论最大值: 1,500 条（15页 × 100条/页）
   建议: 增加 max_pages 配置或减少 hours_limit 时间窗口
```

### 2. 计算所需页数

**公式**:
```
所需页数 = (账号数量 × 平均每小时发推数 × 时间窗口小时数) / 每页大小
```

**示例**:
- List有150个账号
- 每个账号平均每小时发5条推文
- 时间窗口：3小时
- 每页：100条

```
所需页数 = (150 × 5 × 3) / 100 = 2,250 / 100 = 22.5页
建议配置: max_pages = 25页（留有余量）
```

### 3. 监控实际数据量

查看日志中的统计信息：
```
分页获取完成，总共获取 1,350 条有效推文（过滤 200 条），共 15 页
```

如果经常接近或达到页数限制，建议增加 `max_pages`。

## 🎯 推荐配置

### 小型List（<50个账号）
```json
{
  "max_pages": 15,    // 1,500条推文
  "page_size": 100
}
```

### 中型List（50-100个账号）
```json
{
  "max_pages": 30,    // 3,000条推文
  "page_size": 100
}
```

### 大型List（100-200个账号）
```json
{
  "max_pages": 50,    // 5,000条推文
  "page_size": 100
}
```

### 超大型List（>200个账号）或热门事件
```json
{
  "max_pages": 100,   // 10,000条推文
  "page_size": 100
}
```

## 🔍 智能停止机制的保护

即使增加了页数限制，**智能停止机制**仍然会保护你：

1. **时间窗口保护**: 只拉取过去N小时的推文（默认3小时）
2. **项目级别跟踪**: 跟踪每个项目的时间线，避免因单个项目超时导致其他项目遗漏
3. **自动停止**: 当所有项目都超过时间限制时，自动停止拉取

## 📝 注意事项

1. **API限制**: 增加页数会增加API请求次数，注意API速率限制
2. **性能影响**: 更多页数意味着更长的爬取时间
3. **时间窗口**: 如果数据量很大，考虑减少 `hours_limit` 而不是无限增加页数
4. **实际页大小**: API可能返回少于100条/页的数据，实际数据量可能小于理论值

## 🚨 漏数据检测

系统会在以下情况发出警告：
- 达到最大页数限制
- 获取的数据量达到理论最大值的90%以上

如果看到警告，请：
1. 检查日志中的实际数据量
2. 评估是否需要增加 `max_pages`
3. 或者减少 `hours_limit` 时间窗口

## 📊 监控建议

定期检查：
1. 日志中是否出现页数限制警告
2. 实际获取的数据量是否接近理论最大值
3. List中账号数量的变化
4. 账号的平均发推频率

根据这些指标动态调整 `max_pages` 配置。

